From: Jeremy Bicha <jbicha@debian.org>
Date: Wed, 16 Feb 2022 09:42:50 -0500
Subject: Revert "timezone: Build against gweather-4.0"

This reverts commit 34462d5c6255cd432044a7d9799ac055991b552e.
---
 gnome-initial-setup/meson.build                    |  2 +-
 .../pages/timezone/gis-timezone-page.c             | 23 +++++++++++-----------
 .../pages/timezone/gis-timezone-page.ui            |  2 +-
 3 files changed, 13 insertions(+), 14 deletions(-)

diff --git a/gnome-initial-setup/meson.build b/gnome-initial-setup/meson.build
index 43321ec..35c1668 100644
--- a/gnome-initial-setup/meson.build
+++ b/gnome-initial-setup/meson.build
@@ -35,7 +35,7 @@ dependencies = [
     dependency ('gnome-desktop-4', fallback: ['gnome-desktop', 'libgnome_desktop_base_dep']),
     dependency ('gsettings-desktop-schemas', version: '>= 3.37.1'),
     dependency ('fontconfig'),
-    dependency ('gweather4', fallback: ['libgweather', 'libgweather_dep']),
+    dependency ('gweather-3.0'),
     dependency ('goa-1.0'),
     dependency ('goa-backend-1.0'),
     dependency ('gtk+-3.0', version: '>= 3.11.3'),
diff --git a/gnome-initial-setup/pages/timezone/gis-timezone-page.c b/gnome-initial-setup/pages/timezone/gis-timezone-page.c
index e0a6d3d..573b876 100644
--- a/gnome-initial-setup/pages/timezone/gis-timezone-page.c
+++ b/gnome-initial-setup/pages/timezone/gis-timezone-page.c
@@ -39,6 +39,7 @@
 #include <geoclue.h>
 #include <geocode-glib/geocode-glib.h>
 
+#define GWEATHER_I_KNOW_THIS_IS_UNSTABLE
 #include <libgweather/gweather.h>
 
 #include "timedated.h"
@@ -125,20 +126,20 @@ set_location (GisTimezonePage  *page,
 {
   GisTimezonePagePrivate *priv = gis_timezone_page_get_instance_private (page);
 
-  g_clear_object (&priv->current_location);
+  g_clear_pointer (&priv->current_location, gweather_location_unref);
 
   gtk_widget_set_visible (priv->search_overlay, (location == NULL));
   gis_page_set_complete (GIS_PAGE (page), (location != NULL));
 
   if (location)
     {
-      GTimeZone *zone;
+      GWeatherTimezone *zone;
       const char *tzid;
 
-      priv->current_location = g_object_ref (location);
+      priv->current_location = gweather_location_ref (location);
 
       zone = gweather_location_get_timezone (location);
-      tzid = g_time_zone_get_identifier (zone);
+      tzid = gweather_timezone_get_tzid (zone);
 
       cc_timezone_map_set_timezone (CC_TIMEZONE_MAP (priv->map), tzid);
 
@@ -157,18 +158,18 @@ on_location_notify (GClueSimple *simple,
   GisTimezonePagePrivate *priv = gis_timezone_page_get_instance_private (page);
   GClueLocation *location;
   gdouble latitude, longitude;
-  g_autoptr(GWeatherLocation) world = gweather_location_get_world ();
-  g_autoptr(GWeatherLocation) glocation = NULL;
+  GWeatherLocation *glocation = NULL;
 
   location = gclue_simple_get_location (simple);
 
   latitude = gclue_location_get_latitude (location);
   longitude = gclue_location_get_longitude (location);
 
-  glocation = gweather_location_find_nearest_city (world, latitude, longitude);
+  glocation = gweather_location_find_nearest_city (NULL, latitude, longitude);
   priv->in_geoclue_callback = TRUE;
   set_location (page, glocation);
   priv->in_geoclue_callback = FALSE;
+  gweather_location_unref (glocation);
 }
 
 static void
@@ -228,13 +229,12 @@ entry_text_changed (GtkEditable *editable,
   priv->search_entry_text_changed_id = 0;
 }
 
-#if 0
 static void
 entry_location_changed (GObject *object, GParamSpec *param, GisTimezonePage *page)
 {
   GisTimezonePagePrivate *priv = gis_timezone_page_get_instance_private (page);
   GWeatherLocationEntry *entry = GWEATHER_LOCATION_ENTRY (object);
-  g_autoptr(GWeatherLocation) location = NULL;
+  GWeatherLocation *location;
 
   location = gweather_location_entry_get_location (entry);
   if (!location)
@@ -243,8 +243,9 @@ entry_location_changed (GObject *object, GParamSpec *param, GisTimezonePage *pag
   priv->in_search = TRUE;
   set_location (page, location);
   priv->in_search = FALSE;
+
+  gweather_location_unref (location);
 }
-#endif
 
 #define GETTEXT_PACKAGE_TIMEZONES "gnome-control-center-2.0-timezones"
 
@@ -446,10 +447,8 @@ gis_timezone_page_constructed (GObject *object)
   priv->search_entry_text_changed_id =
       g_signal_connect (priv->search_entry, "changed",
                         G_CALLBACK (entry_text_changed), page);
-#if 0
   g_signal_connect (priv->search_entry, "notify::location",
                     G_CALLBACK (entry_location_changed), page);
-#endif
   g_signal_connect (priv->search_entry, "map",
                     G_CALLBACK (entry_mapped), page);
   g_signal_connect (priv->map, "location-changed",
diff --git a/gnome-initial-setup/pages/timezone/gis-timezone-page.ui b/gnome-initial-setup/pages/timezone/gis-timezone-page.ui
index 1f81d3e..07fc352 100644
--- a/gnome-initial-setup/pages/timezone/gis-timezone-page.ui
+++ b/gnome-initial-setup/pages/timezone/gis-timezone-page.ui
@@ -28,7 +28,7 @@
             <property name="orientation">vertical</property>
             <property name="spacing">14</property>
             <child>
-              <object class="GtkEntry" id="search_entry">
+              <object class="GWeatherLocationEntry" id="search_entry">
                 <property name="visible">True</property>
                 <property name="halign">center</property>
                 <property name="max-width-chars">55</property>
